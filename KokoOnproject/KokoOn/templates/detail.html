{% extends 'base.html' %}
{% block title %}KokoOn Detail{% endblock %}

    {% block contents %}
    <br>
    <div class="container">
        <div class="row">
          <div class="col offset-3">
            <h2>{{object.title}}</h2>
            <p>{{object.comment}}</p>
            <br>
            <p>{{object.posted_at}}に投稿</p>

            {% if request.user == object.user %}
            <form method="POST">
            <a href="{% url 'KokoOn:mood_delete' object.pk %}"
              class="btn btn-primary my-2">消去する</a>
            {% endif %}
            
          </div>
        </div>

        <div class="row mt-5">
          <div class="col offset-3">
            <h3>コメント</h3>
            <hr>

            {% if user.is_authenticated %}
            <div class="comment-form-area mb-4 p-3 border rounded bg-light">
                <form method="post">
                    {% csrf_token %}
                    {{ comment_form.text }} 
                    <div class="d-grid mt-2">
                        <button type="submit" class="btn btn-success">コメントする</button>
                    </div>
                </form>
            </div>
            {% else %}
            <p class="text-center text-muted">
                <a href="{% url 'accounts:login' %}">ログイン</a>するとコメントできます。
            </p>
            {% endif %}
            {% for comment in comments %}
            <div class="comment-item mb-3 p-3 border rounded">
              <p class="mb-1">
                <strong>{{ comment.user.username }}</strong>
                <small class="text-muted">({{comment.posted_at}})</small> 
              </p>
              
              <p>{{ comment.clean_text }}</p>

              {% if comment.has_youtube %}
              <div class="youtube-preview" data-video-id="{{ comment.youtube_id }}">
                <img src="https://img.youtube.com/vi/{{ comment.youtube_id }}/hqdefault.jpg"
                      alt="YouTube Thumbnail"
                      class="youtube-thumbnail"
                      onclick="showPlayer('{{ comment.youtube_id }}', this)">
                <div class="play-overlay">▶</div>
              </div>
              {% endif %}
              </div>
            {% empty %}
            <p class="text-muted">まだコメントはありません</p>
            {% endfor %}

          </div>
        </div>

        <script>
        /**
         * サムネイルをクリックした際にYouTubeプレイヤーに切り替える関数
         * @param {string} videoId - YouTubeの動画ID
         * @param {HTMLElement} clickedElement - クリックされたimg要素
         */
        function showPlayer(videoId, clickedElement) {
            // 現在クリックされたサムネイルの親要素 (.youtube-preview) を見つける
            const previewDiv = clickedElement.closest('.youtube-preview');
            if (!previewDiv) return;
            
            // サムネイルと再生アイコンを非表示にする
            clickedElement.style.display = 'none';
            previewDiv.querySelector('.play-overlay').style.display = 'none';
        
            // iframe (埋め込みプレイヤー) を作成して追加
            const iframe = document.createElement('iframe');
            iframe.width = "100%";
            iframe.height = "315";
            // autoplay=1 を付けて、クリック後すぐに再生されるようにする
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            iframe.frameBorder = "0";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
            iframe.allowFullscreen = true;
            
            previewDiv.appendChild(iframe);
        }
        </script>
        </div>
    {% endblock %}